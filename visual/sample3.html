<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>VivaGraphs webgl dynamic graph test page</title>
    <script src="jquery-2.1.1.min.js"></script>
    <script src="vivagraph.js"></script>
    <script type='text/javascript'>
        /*global Viva*/
        var colors = [
            0x1f77b4ff, 0xaec7e8ff
        ];

        var user_to_look_at = "58335770";

        function beginAddNodesLoop(graph) {

            graph.beginUpdate();

            $.getJSON("http://localhost:4567/userrelations/" + user_to_look_at + "/2", function (d) {
                $.each(d, function (key, val) {
                    graph.addLink(val.source, val.target);
                })

            }).done(function () {
                graph.endUpdate();
            });

        }

        function onLoad() {
            var graph = Viva.Graph.graph();

            var layout = Viva.Graph.Layout.forceDirected(graph, {
                springLength: 3000,
                springCoeff: 0.00008,
                dragCoeff: 0.001,
                gravity: -600.2
            });

            var graphics = Viva.Graph.View.webglGraphics();

            graphics
                    .node(function (node) {
                        if(node.id.indexOf("user")>-1) {
                            if(node.id.indexOf(user_to_look_at) > -1) {
                                console.log("FOUND");
                                return Viva.Graph.View.webglSquare(300, 0xc49c94ff);
                            } else {
                                return Viva.Graph.View.webglSquare(200, 0x1f77b4ff);
                            }
                        } else {
                            return Viva.Graph.View.webglSquare(200, 0xaec7e8ff);
                        }

                        //return Viva.Graph.View.webglSquare(1 + Math.random() * 10, colors[(Math.random() * colors.length) << 0]);

                    })
                    .link(function (link) {

                        if(link.fromId.indexOf(user_to_look_at) > -1) {
                            return Viva.Graph.View.webglLine(0x2ca02cff);
                        } else {
                            return Viva.Graph.View.webglLine(0xff7f0eff);
                        }

                    });

            var renderer = Viva.Graph.View.renderer(graph,
                    {
                        layout: layout,
                        graphics: graphics,
                        container: document.getElementById('graph1'),
                        renderLinks: true
                    });

            var events = Viva.Graph.webglInputEvents(graphics, graph);
            events.mouseEnter(function (node) {
                console.log('Mouse entered node: ' + node.id);
            }).mouseLeave(function (node) {
                console.log('Mouse left node: ' + node.id);
            }).dblClick(function (node) {
                console.log('Double click on node: ' + node.id);
            }).click(function (node) {
                console.log('Single click on node: ' + node.id);
            });

            renderer.run(100);
            //graph.addLink(1, 2)
            beginAddNodesLoop(graph);
            l = layout;
        }
    </script>
    <style type='text/css'>
        .node {
            background-color: #00a2e8;
            width: 10px;
            height: 10px;
            position: absolute;
        }

        .link {
            background-color: #dddddd;
            position: absolute;
        }

        #graph1 {
            position: absolute;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body onload="onLoad()" style="background-color: white;">
<div id='graph1'></div>
</body>
</html>